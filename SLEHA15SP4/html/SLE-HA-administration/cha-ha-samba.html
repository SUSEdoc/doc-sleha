<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SLE HA 15 SP4 | Administration Guide | Samba clustering</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Samba clustering | SLE HA 15 SP4"/>
<meta name="description" content="A clustered Samba server provides a High Availability …"/>
<meta name="product-name" content="SUSE Linux Enterprise High Availability"/>
<meta name="product-number" content="15 SP4"/>
<meta name="book-title" content="Administration Guide"/>
<meta name="chapter-title" content="Chapter 26. Samba clustering"/>
<meta name="tracker-url" content="https://bugzilla.suse.com/enter_bug.cgi"/>
<meta name="tracker-type" content="bsc"/>
<meta name="tracker-bsc-component" content="Documentation"/>
<meta name="tracker-bsc-product" content="PUBLIC SUSE Linux Enterprise High Availability Extension 15 SP4"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Samba clustering | SLE HA 15 SP4"/>
<meta property="og:description" content="A clustered Samba server provides a High Availability solution in your heterogeneous networks. This chapter explains some ba…"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Samba clustering | SLE HA 15 SP4"/>
<meta name="twitter:description" content="A clustered Samba server provides a High Availability solution in your heterogeneous networks. This chapter explains some ba…"/>
<link rel="prev" href="cha-ha-cluster-md.html" title="Chapter 25. Cluster multi-device (Cluster MD)"/><link rel="next" href="cha-ha-rear.html" title="Chapter 27. Disaster recovery with ReaR (Relax-and-Recover)"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script><meta name="edit-url" content="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml"/></head><body class="draft wide offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">Administration Guide</a><span> / </span><a class="crumb" href="part-storage.html">Storage and data replication</a><span> / </span><a class="crumb" href="cha-ha-samba.html">Samba clustering</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">Administration Guide</div><ol><li><a href="pre-ha.html" class=" "><span class="title-number"> </span><span class="title-name">Preface</span></a></li><li><a href="part-install.html" class="has-children "><span class="title-number">I </span><span class="title-name">Installation and setup</span></a><ol><li><a href="cha-ha-concepts.html" class=" "><span class="title-number">1 </span><span class="title-name">Product overview</span></a></li><li><a href="cha-ha-requirements.html" class=" "><span class="title-number">2 </span><span class="title-name">System requirements and recommendations</span></a></li><li><a href="cha-ha-install.html" class=" "><span class="title-number">3 </span><span class="title-name">Installing SUSE Linux Enterprise High Availability</span></a></li><li><a href="cha-ha-ycluster.html" class=" "><span class="title-number">4 </span><span class="title-name">Using the YaST cluster module</span></a></li></ol></li><li><a href="part-config.html" class="has-children "><span class="title-number">II </span><span class="title-name">Configuration and administration</span></a><ol><li><a href="cha-ha-config-basics.html" class=" "><span class="title-number">5 </span><span class="title-name">Configuration and administration basics</span></a></li><li><a href="sec-ha-config-basics-resources.html" class=" "><span class="title-number">6 </span><span class="title-name">Configuring cluster resources</span></a></li><li><a href="sec-ha-config-basics-constraints.html" class=" "><span class="title-number">7 </span><span class="title-name">Configuring resource constraints</span></a></li><li><a href="cha-ha-manage-resources.html" class=" "><span class="title-number">8 </span><span class="title-name">Managing cluster resources</span></a></li><li><a href="sec-ha-config-basics-remote.html" class=" "><span class="title-number">9 </span><span class="title-name">Managing services on remote hosts</span></a></li><li><a href="cha-ha-agents.html" class=" "><span class="title-number">10 </span><span class="title-name">Adding or modifying resource agents</span></a></li><li><a href="cha-ha-monitor-clusters.html" class=" "><span class="title-number">11 </span><span class="title-name">Monitoring clusters</span></a></li><li><a href="cha-ha-fencing.html" class=" "><span class="title-number">12 </span><span class="title-name">Fencing and STONITH</span></a></li><li><a href="cha-ha-storage-protect.html" class=" "><span class="title-number">13 </span><span class="title-name">Storage protection and SBD</span></a></li><li><a href="cha-ha-qdevice.html" class=" "><span class="title-number">14 </span><span class="title-name">QDevice and QNetd</span></a></li><li><a href="cha-ha-acl.html" class=" "><span class="title-number">15 </span><span class="title-name">Access control lists</span></a></li><li><a href="cha-ha-netbonding.html" class=" "><span class="title-number">16 </span><span class="title-name">Network device bonding</span></a></li><li><a href="cha-ha-lb.html" class=" "><span class="title-number">17 </span><span class="title-name">Load balancing</span></a></li><li><a href="cha-ha-virtualization.html" class=" "><span class="title-number">18 </span><span class="title-name">High Availability for virtualization</span></a></li><li><a href="cha-ha-geo.html" class=" "><span class="title-number">19 </span><span class="title-name">Geo clusters (multi-site clusters)</span></a></li></ol></li><li class="active"><a href="part-storage.html" class="has-children you-are-here"><span class="title-number">III </span><span class="title-name">Storage and data replication</span></a><ol><li><a href="cha-ha-storage-dlm.html" class=" "><span class="title-number">20 </span><span class="title-name">Distributed Lock Manager (DLM)</span></a></li><li><a href="cha-ha-ocfs2.html" class=" "><span class="title-number">21 </span><span class="title-name">OCFS2</span></a></li><li><a href="cha-ha-gfs2.html" class=" "><span class="title-number">22 </span><span class="title-name">GFS2</span></a></li><li><a href="cha-ha-drbd.html" class=" "><span class="title-number">23 </span><span class="title-name">DRBD</span></a></li><li><a href="cha-ha-clvm.html" class=" "><span class="title-number">24 </span><span class="title-name">Cluster logical volume manager (Cluster LVM)</span></a></li><li><a href="cha-ha-cluster-md.html" class=" "><span class="title-number">25 </span><span class="title-name">Cluster multi-device (Cluster MD)</span></a></li><li><a href="cha-ha-samba.html" class=" you-are-here"><span class="title-number">26 </span><span class="title-name">Samba clustering</span></a></li><li><a href="cha-ha-rear.html" class=" "><span class="title-number">27 </span><span class="title-name">Disaster recovery with ReaR (Relax-and-Recover)</span></a></li></ol></li><li><a href="part-maintenance.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Maintenance and upgrade</span></a><ol><li><a href="cha-ha-maintenance.html" class=" "><span class="title-number">28 </span><span class="title-name">Executing maintenance tasks</span></a></li><li><a href="cha-ha-migration.html" class=" "><span class="title-number">29 </span><span class="title-name">Upgrading your cluster and updating software packages</span></a></li></ol></li><li><a href="part-appendix.html" class="has-children "><span class="title-number">V </span><span class="title-name">Appendix</span></a><ol><li><a href="app-ha-troubleshooting.html" class=" "><span class="title-number">A </span><span class="title-name">Troubleshooting</span></a></li><li><a href="app-naming.html" class=" "><span class="title-number">B </span><span class="title-name">Naming conventions</span></a></li><li><a href="app-ha-management.html" class=" "><span class="title-number">C </span><span class="title-name">Cluster management tools (command line)</span></a></li><li><a href="app-crmreport-nonroot.html" class=" "><span class="title-number">D </span><span class="title-name">Running cluster reports without <code class="systemitem">root</code> access</span></a></li></ol></li><li><a href="gl-heartb.html" class=" "><span class="title-number"> </span><span class="title-name">Glossary</span></a></li><li><a href="bk02ape.html" class=" "><span class="title-number">E </span><span class="title-name">GNU licenses</span></a></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="cha-ha-samba" data-id-title="Samba clustering"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname">SUSE Linux Enterprise High Availability</span> <span class="productnumber">15 SP4</span></div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">26 </span><span class="title-name">Samba clustering</span></span> <a title="Permalink" class="permalink" href="cha-ha-samba.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div><div><div class="abstract"><p>
    A clustered Samba server provides a High Availability solution in your
    heterogeneous networks. This chapter explains some background
    information and how to set up a clustered Samba server.
   </p></div></div></div></div><section class="sect1" id="sec-ha-samba-overview" data-id-title="Conceptual overview"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.1 </span><span class="title-name">Conceptual overview</span></span> <a title="Permalink" class="permalink" href="cha-ha-samba.html#sec-ha-samba-overview">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   Trivial Database (TDB) has been used by Samba for many years. It allows
   multiple applications to write simultaneously. To make sure all write
   operations are successfully performed and do not collide with each other,
   TDB uses an internal locking mechanism.
  </p><p>
   Cluster Trivial Database (CTDB) is a small extension of the existing TDB.
   CTDB is described by the project as a <span class="quote">“<span class="quote">cluster implementation of
   the TDB database used by Samba and other projects to store temporary
   data</span>”</span>.
  </p><p>
   Each cluster node runs a local CTDB daemon. Samba communicates with its
   local CTDB daemon instead of writing directly to its TDB. The daemons
   exchange metadata over the network, but actual write and read operations
   are done on a local copy with fast storage. The concept of CTDB is
   displayed in <a class="xref" href="cha-ha-samba.html#fig-ha-samba-overview" title="Structure of a CTDB cluster">Figure 26.1, “Structure of a CTDB cluster”</a>.
  </p><div id="id-1.4.5.9.3.5" data-id-title="CTDB for Samba only" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note: CTDB for Samba only</div><p>
    The current implementation of the CTDB Resource Agent configures CTDB to
    only manage Samba. Everything else, including IP failover, should be
    configured with Pacemaker.
   </p><p>
    CTDB is only supported for completely homogeneous clusters. For example,
    all nodes in the cluster need to have the same architecture. You cannot
    mix x86 with AMD64.
   </p></div><div class="figure" id="fig-ha-samba-overview"><div class="figure-contents"><div class="mediaobject"><a href="images/ha_samba.png"><img src="images/ha_samba.png" width="80%" alt="Structure of a CTDB cluster" title="Structure of a CTDB cluster"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 26.1: </span><span class="title-name">Structure of a CTDB cluster </span></span><a title="Permalink" class="permalink" href="cha-ha-samba.html#fig-ha-samba-overview">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div><p>
   A clustered Samba server must share certain data:
  </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
     Mapping table that associates Unix user and group IDs to Windows users
     and groups.
    </p></li><li class="listitem"><p>
     The user database must be synchronized between all nodes.
    </p></li><li class="listitem"><p>
     Join information for a member server in a Windows domain must be
     available on all nodes.
    </p></li><li class="listitem"><p>
     Metadata needs to be available on all nodes, like active SMB sessions,
     share connections, and various locks.
    </p></li></ul></div><p>
   The goal is that a clustered Samba server with N+1 nodes is faster than
   with only N nodes. One node is not slower than an unclustered Samba
   server.
  </p></section><section class="sect1" id="sec-ha-samba-basicconf" data-id-title="Basic configuration"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.2 </span><span class="title-name">Basic configuration</span></span> <a title="Permalink" class="permalink" href="cha-ha-samba.html#sec-ha-samba-basicconf">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div></div></div><div id="id-1.4.5.9.4.3" data-id-title="Changed configuration files" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note: Changed configuration files</div><p>
    The CTDB Resource Agent automatically changes
    <code class="filename">/etc/sysconfig/ctdb</code>. Use <code class="command">crm
    ra</code> <code class="option">info CTDB</code> to list all parameters
    that can be specified for the CTDB resource.
   </p></div><p>
   To set up a clustered Samba server, proceed as follows:
  </p><div class="procedure" id="pro-ha-samba-basicconf" data-id-title="Setting up a basic clustered Samba server"><div class="title-container"><div class="procedure-title-wrap"><div class="procedure-title"><span class="title-number-name"><span class="title-number">Procedure 26.1: </span><span class="title-name">Setting up a basic clustered Samba server </span></span><a title="Permalink" class="permalink" href="cha-ha-samba.html#pro-ha-samba-basicconf">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
     Prepare your cluster:
    </p><ol type="a" class="substeps"><li class="step"><p>
       Make sure the following packages are installed before you proceed:
       <span class="package">ctdb</span>,
       <span class="package">tdb-tools</span>, and
       <span class="package">samba</span> (needed for
       <code class="literal">smb</code> and <code class="literal">nmb</code> resources).
      </p></li><li class="step"><p>
       Configure your cluster (Pacemaker, OCFS2) as described in this guide
       in <a class="xref" href="part-config.html" title="Part II. Configuration and administration">Part II, “Configuration and administration”</a>.
      </p></li><li class="step"><p>
       Configure a shared file system, like OCFS2, and mount it, for
       example, on <code class="filename">/srv/clusterfs</code>.
        See <a class="xref" href="cha-ha-ocfs2.html" title="Chapter 21. OCFS2">Chapter 21, <em>OCFS2</em></a> for more information.
      </p></li><li class="step"><p>
       If you want to turn on POSIX ACLs, enable it:
      </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
         For a new OCFS2 file system use:
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">mkfs.ocfs2 --fs-features=xattr ...</code></pre></div></li><li class="listitem"><p>
         For an existing OCFS2 file system use:
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">tunefs.ocfs2 --fs-feature=xattr <em class="replaceable">DEVICE</em></code></pre></div><p>
         Make sure the <code class="option">acl</code> option is specified in the file
         system resource. Use the <code class="command">crm</code> shell as follows:
        </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt custom">crm(live)configure# </code><code class="command">primitive ocfs2-3 ocf:heartbeat:Filesystem params options="acl" ...</code></pre></div></li></ul></div></li><li class="step"><p>
       Make sure the services <code class="systemitem">ctdb</code>,
       <code class="systemitem">smb</code>, and
       <code class="systemitem">nmb</code> are disabled:
      </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl disable ctdb</code>
<code class="prompt root"># </code><code class="command">systemctl disable smb</code>
<code class="prompt root"># </code><code class="command">systemctl disable nmb</code></pre></div></li><li class="step"><p>
       Open port <code class="literal">4379</code> of your firewall on all nodes. This
       is needed for CTDB to communicate with other cluster nodes.
      </p></li></ol></li><li class="step"><p>
     Create a directory for the CTDB lock on the shared file system:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">mkdir -p /srv/clusterfs/samba/</code></pre></div></li><li class="step"><p>
     In <code class="filename">/etc/ctdb/nodes</code> insert all nodes which contain
     all private IP addresses of each node in the cluster:
    </p><div class="verbatim-wrap"><pre class="screen">192.168.1.10
192.168.1.11</pre></div></li><li class="step"><p>
     Configure Samba. Add the following lines in the
     <code class="literal">[global]</code> section of
     <code class="filename">/etc/samba/smb.conf</code>. Use the host name of your
     choice in place of "CTDB-SERVER" (all nodes in the cluster will appear
     as one big node with this name, effectively):
    </p><div class="verbatim-wrap"><pre class="screen">[global]
    # ...
    # settings applicable for all CTDB deployments
    netbios name = CTDB-SERVER
    clustering = yes
    idmap config * : backend = tdb2
    passdb backend = tdbsam
    ctdbd socket = /var/lib/ctdb/ctdb.socket
    # settings necessary for CTDB on OCFS2
    fileid:algorithm = fsid
    vfs objects = fileid
    # ...</pre></div></li><li class="step"><p>
     Copy the configuration file to all of your nodes by using
     <code class="command">csync2</code>:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">csync2 -xv</code></pre></div><p>
     For more information, see
     <a class="xref" href="cha-ha-ycluster.html#pro-ha-installation-setup-csync2-start" title="Synchronizing the configuration files with Csync2">Procedure 4.9, “Synchronizing the configuration files with Csync2”</a>.
    </p></li><li class="step"><p>
     Add a CTDB resource to the cluster:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">crm configure</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">primitive ctdb CTDB params \
    ctdb_manages_winbind="false" \
    ctdb_manages_samba="false" \
    ctdb_recovery_lock="/srv/clusterfs/samba/ctdb.lock" \
    ctdb_socket="/var/lib/ctdb/ctdb.socket" \
      op monitor interval="10" timeout="20" \
      op start interval="0" timeout="90" \
      op stop interval="0" timeout="100"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">primitive nmb systemd:nmb \
    op start timeout="60" interval="0" \
    op stop timeout="60" interval="0" \
    op monitor interval="60" timeout="60"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">primitive smb systemd:smb \
    op start timeout="60" interval="0" \
    op stop timeout="60" interval="0" \
    op monitor interval="60" timeout="60"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">group g-ctdb ctdb nmb smb</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">clone cl-ctdb g-ctdb meta interleave="true"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">colocation col-ctdb-with-clusterfs inf: cl-ctdb cl-clusterfs</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">order o-clusterfs-then-ctdb Mandatory: cl-clusterfs cl-ctdb</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">commit</code></pre></div></li><li class="step"><p>
     Add a clustered IP address:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt custom">crm(live)configure# </code><code class="command">primitive ip IPaddr2 params ip=192.168.2.222 \
    unique_clone_address="true" \
    op monitor interval="60" \
    meta resource-stickiness="0"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">clone cl-ip ip \
    meta interleave="true" clone-node-max="2" globally-unique="true"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">colocation col-ip-with-ctdb 0: cl-ip cl-ctdb</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">order o-ip-then-ctdb 0: cl-ip cl-ctdb</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">commit</code></pre></div><p>
     If <code class="literal">unique_clone_address</code> is set to
     <code class="literal">true</code>, the IPaddr2 resource agent adds a clone ID to
     the specified address, leading to three different IP addresses. These
     are usually not needed, but help with load balancing. For further
     information about this topic, see <a class="xref" href="cha-ha-lb.html#sec-ha-lb-lvs" title="17.2. Configuring load balancing with Linux Virtual Server">Section 17.2, “Configuring load balancing with Linux Virtual Server”</a>.
    </p></li><li class="step"><p>
     Commit your change:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt custom">crm(live)configure# </code><code class="command">commit</code></pre></div></li><li class="step"><p>
     Check the result:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">crm status</code>
Clone Set: cl-storage [dlm]
     Started: [ factory-1 ]
     Stopped: [ factory-0 ]
Clone Set: cl-clusterfs [clusterfs]
     Started: [ factory-1 ]
     Stopped: [ factory-0 ]
 Clone Set: cl-ctdb [g-ctdb]
     Started: [ factory-1 ]
     Started: [ factory-0 ]
 Clone Set: cl-ip [ip] (unique)
     ip:0       (ocf:heartbeat:IPaddr2):       Started factory-0
     ip:1       (ocf:heartbeat:IPaddr2):       Started factory-1</pre></div></li><li class="step"><p>
     Test from a client machine. On a Linux client, run the following
     command to see if you can copy files from and to the system:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">smbclient //192.168.2.222/myshare</code></pre></div></li></ol></div></div></section><section class="sect1" id="sec-ha-samba-ad" data-id-title="Joining an Active Directory domain"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.3 </span><span class="title-name">Joining an Active Directory domain</span></span> <a title="Permalink" class="permalink" href="cha-ha-samba.html#sec-ha-samba-ad">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   Active Directory (AD) is a directory service for Windows server systems.
  </p><p>
   The following instructions outline how to join a CTDB cluster to an
   Active Directory domain:
  </p><div class="procedure" id="pro-ha-samba-ad-join"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
     Create a CTDB resource as described in
     <a class="xref" href="cha-ha-samba.html#pro-ha-samba-basicconf" title="Setting up a basic clustered Samba server">Procedure 26.1, “Setting up a basic clustered Samba server”</a>.
    </p></li><li class="step"><p>
     Install the <span class="package">samba-winbind</span>
     package.
    </p></li><li class="step"><p>
     Disable the <code class="systemitem">winbind</code> service:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">systemctl disable winbind</code></pre></div></li><li class="step"><p>
     Define a winbind cluster resource:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">crm configure</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">primitive winbind systemd:winbind \
    op start timeout="60" interval="0" \
    op stop timeout="60" interval="0" \
    op monitor interval="60" timeout="60"</code>
<code class="prompt custom">crm(live)configure# </code><code class="command">commit</code></pre></div></li><li class="step"><p>
     Edit the <code class="literal">g-ctdb</code> group and insert
     <code class="literal">winbind</code> between the <code class="literal">nmb</code> and
     <code class="literal">smb</code> resources:
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt custom">crm(live)configure# </code><code class="command">edit g-ctdb</code></pre></div><p>
     Save and close the editor with <span class="keycap">:</span><span class="key-connector">–</span><span class="keycap">w</span> (<code class="command">vim</code>).
    </p></li><li class="step"><p>
     Consult your Windows Server documentation for instructions on how to
     set up an Active Directory domain. In this example, we use the
     following parameters:
    </p><div class="informaltable"><table style="border-collapse: collapse; border-top: 1px solid ; border-bottom: 1px solid ; border-left: 1px solid ; border-right: 1px solid ; "><colgroup><col/><col/></colgroup><tbody><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">
         <p>
          AD and DNS server
         </p>
        </td><td style="border-bottom: 1px solid ; ">
<div class="verbatim-wrap"><pre class="screen">win2k3.2k3test.example.com</pre></div>
        </td></tr><tr><td style="border-right: 1px solid ; border-bottom: 1px solid ; ">
         <p>
          AD domain
         </p>
        </td><td style="border-bottom: 1px solid ; ">
<div class="verbatim-wrap"><pre class="screen">2k3test.example.com</pre></div>
        </td></tr><tr><td style="border-right: 1px solid ; ">
         <p>
          Cluster AD member NetBIOS name
         </p>
        </td><td>
<div class="verbatim-wrap"><pre class="screen">CTDB-SERVER</pre></div>
        </td></tr></tbody></table></div></li><li class="step"><p>
     <a class="xref" href="cha-ha-samba.html#pro-ha-samba-config-join-ad" title="Joining Active Directory">Procedure 26.2, “Joining Active Directory”</a>
    </p></li></ol></div></div><p>
   Finally, join your cluster to the Active Directory server:
  </p><div class="procedure" id="pro-ha-samba-config-join-ad" data-id-title="Joining Active Directory"><div class="title-container"><div class="procedure-title-wrap"><div class="procedure-title"><span class="title-number-name"><span class="title-number">Procedure 26.2: </span><span class="title-name">Joining Active Directory </span></span><a title="Permalink" class="permalink" href="cha-ha-samba.html#pro-ha-samba-config-join-ad">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
     Make sure the following files are included in Csync2's
     configuration to become installed on all cluster hosts:
    </p><div class="verbatim-wrap"><pre class="screen">/etc/samba/smb.conf
/etc/security/pam_winbind.conf
/etc/krb5.conf
/etc/nsswitch.conf
/etc/security/pam_mount.conf.xml
/etc/pam.d/common-session</pre></div><p>
     You can also use YaST's <span class="guimenu">Configure Csync2</span>
     module for this task, see
     <a class="xref" href="cha-ha-ycluster.html#sec-ha-installation-setup-csync2" title="4.7. Transferring the configuration to all nodes">Section 4.7, “Transferring the configuration to all nodes”</a>.
    </p></li><li class="step"><p>
     Run YaST and open the <span class="guimenu">Windows Domain Membership</span>
     module from the <span class="guimenu">Network Services</span> entry.
    </p></li><li class="step"><p>
     Enter your domain or workgroup settings and finish with
     <span class="guimenu">Ok</span>.
    </p></li></ol></div></div></section><section class="sect1" id="sec-ha-samba-testing" data-id-title="Debugging and testing clustered Samba"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.4 </span><span class="title-name">Debugging and testing clustered Samba</span></span> <a title="Permalink" class="permalink" href="cha-ha-samba.html#sec-ha-samba-testing">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div></div></div><p>
   To debug your clustered Samba server, the following tools which operate
   on different levels are available:
  </p><div class="variablelist"><dl class="variablelist"><dt id="id-1.4.5.9.6.3.1"><span class="term"><code class="command">ctdb_diagnostics</code>
    </span></dt><dd><p>
      Run this tool to diagnose your clustered Samba server. Detailed debug
      messages should help you track down any problems you might have.
     </p><p>
      The <code class="command">ctdb_diagnostics</code> command searches for the
      following files which must be available on all nodes:
     </p><div class="verbatim-wrap"><pre class="screen">/etc/krb5.conf
/etc/hosts
/etc/ctdb/nodes
/etc/sysconfig/ctdb
/etc/resolv.conf
/etc/nsswitch.conf
/etc/sysctl.conf
/etc/samba/smb.conf
/etc/fstab
/etc/multipath.conf
/etc/pam.d/system-auth
/etc/sysconfig/nfs
/etc/exports
/etc/vsftpd/vsftpd.conf</pre></div><p>
      If the files <code class="filename">/etc/ctdb/public_addresses</code> and
      <code class="filename">/etc/ctdb/static-routes</code> exist, they will be
      checked as well.
     </p></dd><dt id="id-1.4.5.9.6.3.2"><span class="term"><code class="command">ping_pong</code>
    </span></dt><dd><p>
      Check whether your file system is suitable for CTDB with
      <code class="command">ping_pong</code>. It performs certain tests of your
      cluster file system like coherence and performance (see
      <a class="link" href="http://wiki.samba.org/index.php/Ping_pong" target="_blank">http://wiki.samba.org/index.php/Ping_pong</a>) and
      gives some indication how your cluster may behave under high load.
     </p></dd><dt id="id-1.4.5.9.6.3.3"><span class="term"><code class="command">send_arp</code> tool and <code class="systemitem">SendArp</code> resource agent</span></dt><dd><p>
      The <code class="systemitem">SendArp</code> resource agent
      is located in <code class="filename">/usr/lib/heartbeat/send_arp</code> (or
      <code class="filename">/usr/lib64/heartbeat/send_arp</code>). The
      <code class="command">send_arp</code> tool sends out a gratuitous ARP (Address
      Resolution Protocol) packet and can be used for updating other
      machines' ARP tables. It can help to identify communication problems
      after a failover process. If you cannot connect to a node or ping it
      although it shows the clustered IP address for Samba, use the
      <code class="command">send_arp</code> command to test if the nodes only need an
      ARP table update.
     </p><p>
      For more information, refer to
      <a class="link" href="https://gitlab.com/wireshark/wireshark/-/wikis/home" target="_blank">https://gitlab.com/wireshark/wireshark/-/wikis/home</a>.
     </p></dd></dl></div><p>
   To test certain aspects of your cluster file system proceed as follows:
  </p><div class="procedure" id="id-1.4.5.9.6.5" data-id-title="Test coherence and performance of your cluster file system"><div class="title-container"><div class="procedure-title-wrap"><div class="procedure-title"><span class="title-number-name"><span class="title-number">Procedure 26.3: </span><span class="title-name">Test coherence and performance of your cluster file system </span></span><a title="Permalink" class="permalink" href="cha-ha-samba.html#id-1.4.5.9.6.5">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>
     Start the command <code class="command">ping_pong</code> on one node and replace
     the placeholder <em class="replaceable">N</em> with the amount of nodes
     plus one. The file
     <code class="filename"><em class="replaceable">ABSPATH</em>/data.txt</code> is
     available in your shared storage and is therefore accessible on all
     nodes (<em class="replaceable">ABSPATH </em> indicates an absolute path):
    </p><div class="verbatim-wrap"><pre class="screen"><code class="prompt root"># </code><code class="command">ping_pong <em class="replaceable">ABSPATH</em>/data.txt <em class="replaceable">N</em></code></pre></div><p>
     Expect a very high locking rate as you are running only one node. If
     the program does not print a locking rate, replace your cluster file
     system.
    </p></li><li class="step"><p>
     Start a second copy of <code class="command">ping_pong</code> on another node
     with the same parameters.
    </p><p>
     Expect to see a dramatic drop in the locking rate. If any of the
     following applies to your cluster file system, replace it:
    </p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
       <code class="command">ping_pong</code> does not print a locking rate per
       second,
      </p></li><li class="listitem"><p>
       the locking rates in the two instances are not almost equal,
      </p></li><li class="listitem"><p>
       the locking rate did not drop after you started the second instance.
      </p></li></ul></div></li><li class="step"><p>
     Start a third copy of <code class="command">ping_pong</code>. Add another node
     and note how the locking rates change.
    </p></li><li class="step"><p>
     Kill the <code class="command">ping_pong</code> commands one after the other. You
     should observe an increase of the locking rate until you get back to
     the single node case. If you did not get the expected behavior, find
     more information in <a class="xref" href="cha-ha-ocfs2.html" title="Chapter 21. OCFS2">Chapter 21, <em>OCFS2</em></a>.
    </p></li></ol></div></div></section><section class="sect1" id="sec-ha-samba-moreinfo" data-id-title="For more information"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">26.5 </span><span class="title-name">For more information</span></span> <a title="Permalink" class="permalink" href="cha-ha-samba.html#sec-ha-samba-moreinfo">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sleha/edit/main/xml/ha_samba.xml" title="Edit source document"> </a></div></div></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>
     <a class="link" href="http://wiki.samba.org/index.php/CTDB_Setup" target="_blank">http://wiki.samba.org/index.php/CTDB_Setup</a>
    </p></li><li class="listitem"><p>
     <a class="link" href="http://ctdb.samba.org" target="_blank">http://ctdb.samba.org</a>
    </p></li><li class="listitem"><p>
     <a class="link" href="http://wiki.samba.org/index.php/Samba_%26_Clustering" target="_blank">http://wiki.samba.org/index.php/Samba_%26_Clustering</a>
    </p></li></ul></div></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="cha-ha-cluster-md.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 25 </span>Cluster multi-device (Cluster MD)</span></a> </div><div><a class="pagination-link next" href="cha-ha-rear.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 27 </span>Disaster recovery with ReaR (Relax-and-Recover)</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="sect1"><a href="cha-ha-samba.html#sec-ha-samba-overview"><span class="title-number">26.1 </span><span class="title-name">Conceptual overview</span></a></span></li><li><span class="sect1"><a href="cha-ha-samba.html#sec-ha-samba-basicconf"><span class="title-number">26.2 </span><span class="title-name">Basic configuration</span></a></span></li><li><span class="sect1"><a href="cha-ha-samba.html#sec-ha-samba-ad"><span class="title-number">26.3 </span><span class="title-name">Joining an Active Directory domain</span></a></span></li><li><span class="sect1"><a href="cha-ha-samba.html#sec-ha-samba-testing"><span class="title-number">26.4 </span><span class="title-name">Debugging and testing clustered Samba</span></a></span></li><li><span class="sect1"><a href="cha-ha-samba.html#sec-ha-samba-moreinfo"><span class="title-number">26.5 </span><span class="title-name">For more information</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2024</span></div></div></footer></body></html>